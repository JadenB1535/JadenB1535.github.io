<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.3.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>



<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
</head>

<body>
    <img onload="predict(model)" id="image" src="" width="224" height="224" />
    <div id="slideshowContainer">
        <div class="slide" id="slideshow1">
            <h1>Tip 1:</h1>
            <p class="tip">Fit the whole vegetable in the picture.</p>
        </div>
        <div class="slide" id="slideshow2">
            <h1>Tip 2:</h1>
            <p class="tip">Make sure lighting conditions are adequate.</p>
        </div>
        <div class="slide" id="slideshow3">
            <h1>Tip 3:</h1>
            <p class="tip">Use real vegetables for the best result.</p>
        </div>
    </div>
    <div id="timelineContainer">
        <div class="tl">
            <div id="timeline1"></div>
        </div>
        <div class="tl">
            <div id="timeline2"></div>
        </div>
        <div class="tl">
            <div id="timeline3"></div>
        </div>
    </div>
    <label id="btnContainer" for="inputImage">
        <div id="proceedBtn">
            <p id="p1">Loading model...</p>
        </div>
        <input type="file" id="inputImage" capture="camera" accept="image/*">
    </label>
</body>

<script>

    const model = loadModel();// load model immediately to avoid delay when user clicks 'Predict'
    const num_classes = ['Bok Choy', 'Broccoli', 'Cabbage', 'Carrot', 'Cucumber', 'Garlic', 'Ginger', 'Napa Cabbage', 'Potato', 'Red Onion', 'Tomato'];
    let inputTensor = null;
    let inputTensorNormalized = null;
    let inputTensorResized = null;
    let inputTensorBatched = null;

    let slideIndex = 0;
    showSlides();

    function showSlides() {
        let i;
        let slides = document.getElementsByClassName("slide");
        for (i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";
        }
        slideIndex++;
        if (slideIndex > slides.length) {
            document.getElementById('timeline' + (slideIndex - 1).toString()).style.opacity = "0";
            document.getElementById('timeline' + (slideIndex - 1).toString()).style.width = "0%";
            slideIndex = 1;
        }
        slides[slideIndex - 1].style.display = "block";

        document.getElementById('timeline' + slideIndex).style.opacity = "1";
        document.getElementById('timeline' + slideIndex).style.width = "100%";
        if (slideIndex != 1) {
            document.getElementById('timeline' + (slideIndex - 1).toString()).style.width = "0%";
            document.getElementById('timeline' + (slideIndex - 1).toString()).style.opacity = "0";
        }
        setTimeout(showSlides, 5000); // Change image every 2 seconds
    }

    document.querySelector("#inputImage").addEventListener("change", function () {
        const fr = new FileReader();

        fr.addEventListener("load", () => {
            const img = new Image();
            img.src = fr.result;
            document.querySelector("#image").setAttribute("src", fr.result);
            if (document.querySelector("#image").src != null) {
                inputTensor = tf.browser.fromPixels(document.querySelector("#image"));
                inputTensorResized = inputTensor.toFloat();
                const offset = tf.scalar(255.0);
                inputTensorNormalized = inputTensorResized.div(offset);
                inputTensorBatched = inputTensorNormalized.expandDims(0);
                //inputTensor = tf.expandDims(inputTensor, axis=0);
                console.log(inputTensorBatched.shape);
            }

        });
        fr.readAsDataURL(this.files[0]);
    });



    async function loadModel() {
        const model = await tf.loadLayersModel('model.json');
        //alert("model loaded");
        document.getElementById("proceedBtn").style.pointerEvents = "auto";
        document.getElementById("proceedBtn").style.opacity = "1";
        document.getElementById("p1").innerHTML = "Get started";
        return model;
    };

    function predict(model) {

        document.getElementById("p1").innerHTML = "Analysing image...";
        document.getElementById("proceedBtn").style.pointerEvents = "none";
        document.getElementById("proceedBtn").style.opacity = "0.8";
        // first we get the value in the input field
        //const inputImage = document.getElementById('inputImage').value;
        //var inputTensor = tf.tensor([parseFloat(inputImage)]);  // then convert to tensor
        //const inputTensor = tf.expandDims(tf.tensor([parseInt(inputImage)]), 0);  // then convert to tensor
        //const inputTensor = tf.browser.fromPixels(inputImage);
        // inputTensor = tf.expandDims(inputTensor, axis=0);
        // inputTensor = tf.expandDims(inputTensor, axis=0);
        // inputTensor = tf.expandDims(inputTensor, axis=0);
        //console.log(inputTensor.shape);

        // now lets make the prediction, we use .then because the model is a promise
        // (this is confusing as a Python user, but useful so check it out if interested)
        model.then(model => {
            //let array = [];
            let result = model.predict(inputTensorBatched);
            //let prediction = tf.softmax(result);
            result.print();
            //array = result.dataSync();
            //let a = tf.tensor1d(array);
            //a = tf.softmax(a);
            //alert(num_classes[tf.argMax(result, 1).dataSync()[0]]);
            //console.log(num_classes[]);
            inputTensor.dispose();
            inputTensorNormalized.dispose();
            inputTensorResized.dispose();
            inputTensorBatched.dispose();
            result.dispose();
            document.getElementById("proceedBtn").style.pointerEvents = "auto";
            document.getElementById("p1").innerHTML = "Get started";
            document.getElementById("proceedBtn").style.opacity = "1";
        });
    };



</script>

</html>